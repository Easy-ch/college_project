<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>

    <link type="image/x-icon" href="../static/img/favicon.ico" rel="shortcut icon">
    <link rel="stylesheet" href="../static/css/login.css">    
    <link rel="stylesheet" href="../static/css/general_styles.css">
</head>
<body>
    <header>
        <nav class="navbar">        
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="white" class="bi bi-arrows-angle-expand mobile-adapt-icon" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707z"/>
            </svg>

            <!-- Computer nav-bar (screen width > 700px) -->
            <div class="navbar-container">
                <div class="navbar-item"><a href="#">Главная</a></div>
                <div class="navbar-item"><a href="#">Услуги</a></div>
                <div class="navbar-item"><a href="#">Отзывы</a></div>
                <div class="navbar-item"><a href="#">Контакты</a></div>

                <div class="navbar-item"><a href="#">Войти</a></div>

                <div class="logo"><img src="../static/img/logo_white.svg" alt="logo"></div>
            </div>

            <!-- Mobile nav-bar (screen width < 700px) -->
            <ul class="mobile-navbar-container">
                <li class="navbar-item"><a href="#">Главная</a></li>
                <li class="navbar-item"><a href="#">Услуги</a></li>

                <li class="nav-divider"></li>

                <li class="navbar-item"><a href="#">Регистрация</a></li>
                <li class="navbar-item"><a href="#">Войти</a></li>

                <li class="nav-divider"></li>

                <li class="navbar-item"><a href="#">Отзывы</a></li>
            </ul>

        </nav>
    </header>
    <main>
        <div class="login-container">
            <h2 style="font-family: Montserrat, Arial, sans-serif;">Вход</h2>
            <form id="loginForm" method="post"> 
                <div class="input-container">
                    <label for="username">Логин или Email</label>
                    <input type="text" id="username" name="username" placeholder="Введите логин или Email" required>
                </div>
                <div class="input-container">
                    <label for="password">Пароль</label>
                    <input type="password" id="password" name="password" placeholder="Введите пароль" required>
                </div>
                
                <a href="url#">Забыли пароль?</a>
                
                <p id="error-message"></p>
    
                <div class="form-button">
                    <button type="submit">Войти</button>
                </div>
            </form>
        </div>
    </main>
    

    <script>
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();

            let error_tag = document.getElementById("error-message");
    
            const formData = new FormData(e.target);
            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    body: formData
                });
    
                if (response.ok) {
                    const data = await response.json();

                    document.cookie = `refresh_token=${data.refresh_token}; Secure; SameSite=Strict`;
                    localStorage.setItem('access_token', data.access_token);
                    window.location.href = '/profile';
                } else {
                    const error = await response.json();
                    error_tag.textContent(error.detail || "Ошибка входа. Проверьте введённые данные.")
                }
            } catch (error) {
                error_tag.textContent("Не удалось выполнить запрос. Проверьте подключение к интернету.");
            }
        };
    </script>

    <script>
        const API_BASE_URL = "http://127.0.0.1:8000";

        // Получение токенов из localStorage
        const getAccessToken = () => localStorage.getItem("access_token");
        const getRefreshToken = () => localStorage.getItem("refresh_token");

        // Сохранение токенов в localStorage
        const saveTokens = (accessToken, refreshToken) => {
            if (accessToken) localStorage.setItem("access_token", accessToken);
            if (refreshToken) localStorage.setItem("refresh_token", refreshToken);
        };

        // Проверка токена и отправка запроса
        async function fetchProtectedRoute() {
            let accessToken = getAccessToken();

            if (!accessToken) {
                console.log("Access token отсутствует. Попытка обновить токен...");
                const refreshToken = getRefreshToken();

                if (!refreshToken) {
                    window.location.href = '/login';
                    return;
                }

                try {
                    // Запрос на обновление токена
                    const refreshResponse = await fetch("/auth/refresh", {
                        method: "POST",
                        credentials: "include", // Если токен передаётся в cookie
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ refresh_token: refreshToken })
                    });

                    if (!refreshResponse.ok) {
                        console.error("Не удалось обновить токен. Необходима авторизация.");
                        return;
                    }

                    const { access_token: newAccessToken } = await refreshResponse.json();
                    console.log("Новый access_token получен.");
                    saveTokens(newAccessToken);
                    accessToken = newAccessToken;
                } catch (error) {
                    console.error("Ошибка при обновлении токена:", error);
                    return;
                }
            }

            try {
                const response = await fetch("/auth/protected", {
                    method: "GET",
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log("Ответ от защищённого маршрута:", data);
                } else if (response.status === 401) {
                    console.error("Access token недействителен. Попробуйте обновить токен.");
                    localStorage.removeItem("access_token");
                } else {
                    console.error("Ошибка при доступе к защищённому маршруту:", response.status);
                }
            } catch (error) {
                console.error("Ошибка при выполнении запроса:", error);
            }
        }

        // Вызов функции для проверки токенов и получения данных
        fetchProtectedRoute();
    </script>


    <footer>

        <section id="Contacts" style="background-color: #1b1b1b;">

            <div class="footer-title" style="color: white;">
                <span style="margin-inline: 20px; margin-block: 10px; font-weight: 300;">Контактная информация</span>
            </div>

            <div class="centered-grid">
                <div class="footer-grid">
                    <div class="footer-item">
                        <h2>О компании:</h2>
                        <p><i class="bi bi-file-text"></i>&ensp;ИНН: 0000000000</p>
                        <p><i class="bi bi-justify-left"></i>&ensp;ОГРН: 0000000000000</p>
                    </div>
                
                    <div class="footer-vertical-divider"></div>
                    <div class="footer-horizontal-divider"></div>

                    <div class="footer-item">
                        <h2>Контакты:</h2>
                        <p><i class="bi bi-envelope"></i>&ensp;Email: example@gmail.com</p>
                        <p><i class="bi bi-telephone"></i>&ensp;Телефон: +7(000)000-00-00</p>
                    </div>

                    <div class="footer-vertical-divider"></div>
                    <div class="footer-horizontal-divider"></div>

                    <div class="footer-item">
                        <h2>Соцсети:</h2>
                        <p><i class="icon"> </i>&ensp;Email: example@gmail.com</p>
                        <p><i class="icon"> </i>&ensp;Телефон: +7(000)000-00-00</p>
                    </div>
                </div>
            </div>

        </section>


        <div class="footer-copyright">
            <p>Copyright&ensp;2024&ensp;-&ensp;AVrepair.&ensp;All rights reserved.</p>
        </div>

    </footer>

    <script src="../static/js/general_scripts.js" defer></script>
</body>
</html>